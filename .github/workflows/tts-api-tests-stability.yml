name: TTS API Testing 50 iterations (global<=40, per-API status<=3)

on:
  push:
    branches: ["main"]

  schedule:
    # 05:17 KST (20:17 UTC, 전날)
    - cron: "17 20 * * *"
    # 06:11 KST (21:11 UTC, 전날)
    - cron: "11 21 * * *"
    # 17:11 KST (08:11 UTC)
    - cron: "11 8 * * *"

  workflow_dispatch:

concurrency:
  group: api-test-schedule
  cancel-in-progress: false

jobs:
  newman:
    runs-on: ubuntu-latest
    env:
      ITERATIONS: "50"
      APIS_PER_ITERATION: "12"
      ASSERTIONS_PER_API: "3"

      # 글로벌 gate (AssertionError 전체 개수)
      THRESHOLD: "40"

      # API별 gate (Status code mismatch만, API별 카운트 기준)
      STATUS_THRESHOLD_PER_API: "3"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          npm install newman newman-reporter-htmlextra

      - name: Run Newman (capture output)
        run: |
          mkdir -p report
          npx newman run ./collections/tts_collection.json \
            -n $ITERATIONS \
            --reporters cli,htmlextra \
            --reporter-htmlextra-export report/api-test-report.html \
            2>&1 | tee report/newman.log

      # ✅ 트리거/실행자 메타 (항상 실행)
      - name: Set trigger info
        if: always()
        id: trigger
        run: |
          echo "trigger_type=${{ github.event_name }}" >> $GITHUB_OUTPUT

          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "trigger_user=scheduled" >> $GITHUB_OUTPUT
          else
            echo "trigger_user=${{ github.actor }}" >> $GITHUB_OUTPUT
          fi

      # ✅ newman.log 기반 failureCount/요약/실패율 추출 (항상 실행)
      - name: Extract failure meta (from newman.log)
        if: always()
        id: meta
        run: |
          FAILURE_COUNT=$(grep -c "AssertionError" report/newman.log || true)
          TOTAL_ASSERTIONS=$(( $ITERATIONS * $APIS_PER_ITERATION * $ASSERTIONS_PER_API ))

          FAILURE_RATE=$(awk -v f="$FAILURE_COUNT" -v t="$TOTAL_ASSERTIONS" 'BEGIN { if (t==0) print "0.00"; else printf "%.2f", (f/t)*100 }')

          echo "failure_count=$FAILURE_COUNT" >> $GITHUB_OUTPUT
          echo "threshold=$THRESHOLD" >> $GITHUB_OUTPUT
          echo "status_threshold_per_api=$STATUS_THRESHOLD_PER_API" >> $GITHUB_OUTPUT
          echo "total_assertions=$TOTAL_ASSERTIONS" >> $GITHUB_OUTPUT
          echo "failure_rate=$FAILURE_RATE" >> $GITHUB_OUTPUT

          node scripts/summarize-newman-log.js report/newman.log 10 $STATUS_THRESHOLD_PER_API >> $GITHUB_OUTPUT

      # ✅ Gate 판정은 하되, 여기서 job을 죽이지 않음 (Slack 4분기 위해)
      - name: Check gates (global + per-API status)
        if: always()
        id: gate
        continue-on-error: true
        run: |
          node scripts/check-newman-threshold.js report/newman.log $THRESHOLD $STATUS_THRESHOLD_PER_API

      # ✅ gate 결과를 output으로 고정 (항상 실행)
      - name: Set gate result
        if: always()
        id: gate_result
        run: |
          if [ "${{ steps.gate.outcome }}" = "success" ]; then
            echo "gate_pass=true" >> $GITHUB_OUTPUT
          else
            echo "gate_pass=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload HTML report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-report-html
          path: report/api-test-report.html

      - name: Upload Newman log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-log
          path: report/newman.log

      - name: Install jq
        if: always()
        run: sudo apt-get update && sudo apt-get install -y jq

      # ✅ artifact 링크 생성
      - name: Build artifact links
        if: always()
        id: links
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          API_URL="https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts"
          JSON=$(curl -sS -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" "$API_URL")

          HTML_ID=$(echo "$JSON" | jq -r '.artifacts[] | select(.name=="api-test-report-html") | .id' | head -n 1)
          LOG_ID=$(echo "$JSON" | jq -r '.artifacts[] | select(.name=="newman-log") | .id' | head -n 1)

          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ -n "$HTML_ID" ] && [ "$HTML_ID" != "null" ]; then
            HTML_URL="${RUN_URL}/artifacts/${HTML_ID}"
          else
            HTML_URL="${RUN_URL}"
          fi

          if [ -n "$LOG_ID" ] && [ "$LOG_ID" != "null" ]; then
            LOG_URL="${RUN_URL}/artifacts/${LOG_ID}"
          else
            LOG_URL="${RUN_URL}"
          fi

          echo "run_url=$RUN_URL" >> $GITHUB_OUTPUT
          echo "html_url=$HTML_URL" >> $GITHUB_OUTPUT
          echo "log_url=$LOG_URL" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # Slack 4분기
      # gate_pass: true/false
      # failure_count: 0 / >0
      # ---------------------------------------------------------

      # 1) ✅ Clean (assertion error 0)
      - name: Slack notify (1. clean)
        if: always() && steps.meta.outputs.failure_count == '0'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "✅ Newman CI PASS (clean)",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "✅ Newman CI PASS (clean)" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "*Trigger*: `${{ steps.trigger.outputs.trigger_type }}`\n*Actor*: `${{ steps.trigger.outputs.trigger_user }}`" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "*FailureCount(AssertionError)*: *0*\n*Global Threshold*: `${{ steps.meta.outputs.threshold }}`\n*Per-API Status Threshold*: `${{ steps.meta.outputs.status_threshold_per_api }}`" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "*Run*: ${{ steps.links.outputs.run_url }}\n*HTML Report*: ${{ steps.links.outputs.html_url }}\n*newman.log*: ${{ steps.links.outputs.log_url }}" } }
              ]
            }

      # 2) ⚠️ Warning PASS (assertion error >0, global pass, per-API pass)
      - name: Slack notify (2. pass with assertion errors)
        if: always() && steps.meta.outputs.failure_count != '0' && steps.gate_result.outputs.gate_pass == 'true'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "⚠️ Newman CI PASS (warnings: assertion errors)",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "⚠️ Newman CI PASS (warnings: assertion errors)" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "*Trigger*: `${{ steps.trigger.outputs.trigger_type }}`\n*Actor*: `${{ steps.trigger.outputs.trigger_user }}`" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "*FailureCount(AssertionError)*: *${{ steps.meta.outputs.failure_count }}* / Global Threshold: `${{ steps.meta.outputs.threshold }}`\n*Assertion Failure Rate*: *${{ steps.meta.outputs.failure_rate }}%* (`${{ steps.meta.outputs.failure_count }}` / `${{ steps.meta.outputs.total_assertions }}`)\n*Per-API Status Threshold*: `${{ steps.meta.outputs.status_threshold_per_api }}`\n*Gate result*: PASS (global+per-API)" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "*Failed APIs / Assertions (summary)*\n${{ steps.meta.outputs.failure_bullets }}" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "*Run*: ${{ steps.links.outputs.run_url }}\n*HTML Report*: ${{ steps.links.outputs.html_url }}\n*newman.log*: ${{ steps.links.outputs.log_url }}" } }
              ]
            }

      # 3) ❌ Gate FAIL (global은 pass일 수도 있지만, per-API status fail 같은 케이스 포함)
      #    = "assertion error 있지만 global threshold 미만 + API별 threshold fail"를 여기로 태움
      - name: Slack notify (3. gate failed but global may be under threshold)
        if: always() && steps.meta.outputs.failure_count != '0' && steps.gate_result.outputs.gate_pass == 'false'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "❌ Newman CI FAILED (per-API status gate breach or global breach)",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "❌ Newman CI FAILED (gate breach)" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "*Trigger*: `${{ steps.trigger.outputs.trigger_type }}`\n*Actor*: `${{ steps.trigger.outputs.trigger_user }}`" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "*FailureCount(AssertionError)*: *${{ steps.meta.outputs.failure_count }}* / Global Threshold: `${{ steps.meta.outputs.threshold }}`\n*Assertion Failure Rate*: *${{ steps.meta.outputs.failure_rate }}%* (`${{ steps.meta.outputs.failure_count }}` / `${{ steps.meta.outputs.total_assertions }}`)\n*Per-API Status Threshold*: `${{ steps.meta.outputs.status_threshold_per_api }}`\n*Gate result*: FAIL (global OR per-API status)" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "*Failed APIs / Assertions (summary)*\n${{ steps.meta.outputs.failure_bullets }}" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "*Run*: ${{ steps.links.outputs.run_url }}\n*HTML Report*: ${{ steps.links.outputs.html_url }}\n*newman.log*: ${{ steps.links.outputs.log_url }}" } }
              ]
            }

      # 4) (job 최종 상태 반영) gate_fail이면 job을 진짜 실패로 마무리
      - name: Fail job if gate failed
        if: always() && steps.gate_result.outputs.gate_pass == 'false'
        run: |
          echo "[FAIL] Gates failed. Marking job as failed."
          exit 1
