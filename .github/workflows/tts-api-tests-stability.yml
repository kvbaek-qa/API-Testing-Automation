name: TTS API Testing 10 iterations (max failures 10)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  newman:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          npm install newman newman-reporter-htmlextra

      - name: Run Newman (capture output)
        run: |
          mkdir -p report
          # stderr까지 로그에 포함시키기 위해 2>&1 추가
          npx newman run ./collections/tts_collection.json \
            -n 10 \
            --reporters cli,htmlextra \
            --reporter-htmlextra-export report/api-test-report.html \
            2>&1 | tee report/newman.log

      - name: Check failure threshold (max 10)
        run: |
          node scripts/check-newman-threshold.js report/newman.log 10

      - name: Upload HTML report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-report-html
          path: report/api-test-report.html

      - name: Upload Newman log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-log
          path: report/newman.log

      # ✅ Slack 메시지에 넣을 메타 추출 (성공/실패 상관없이 항상 실행)
      - name: Extract failure count
        if: always()
        id: meta
        run: |
          # check-newman-threshold.js가 출력하는 라인:
          # Newman failure count (AssertionError): X
          FAILURE_COUNT=$(grep -oE "Newman failure count \(AssertionError\): [0-9]+" report/newman.log | tail -n 1 | awk '{print $NF}')
          if [ -z "$FAILURE_COUNT" ]; then FAILURE_COUNT=0; fi

          echo "failure_count=$FAILURE_COUNT" >> $GITHUB_OUTPUT
          echo "threshold=10" >> $GITHUB_OUTPUT
          echo "report_path=report/api-test-report.html" >> $GITHUB_OUTPUT

      # ✅ 성공 알림
      - name: Slack notify (success)
        if: success()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "✅ Newman CI SUCCESS",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "✅ Newman CI SUCCESS" }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Repo*: `${{ github.repository }}`\n*Branch*: `${{ github.ref_name }}`\n*FailureCount*: *${{ steps.meta.outputs.failure_count }}* / *Threshold*: *${{ steps.meta.outputs.threshold }}*"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Run*: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n*Artifacts*: (Run 페이지에서 `api-test-report-html`, `newman-log` 확인)"
                  }
                }
              ]
            }

      # ❌ 실패 알림
      - name: Slack notify (failure)
        if: failure()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "❌ Newman CI FAILED",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "❌ Newman CI FAILED" }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Repo*: `${{ github.repository }}`\n*Branch*: `${{ github.ref_name }}`\n*FailureCount*: *${{ steps.meta.outputs.failure_count }}* / *Threshold*: *${{ steps.meta.outputs.threshold }}*"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Why*: AssertionError count exceeded threshold (or Newman step failed)\n*Run*: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n*Artifacts*: (Run 페이지에서 `api-test-report-html`, `newman-log` 확인)"
                  }
                }
              ]
            }
